# ComfyUI Server - å¤šäººå”ä½œç”Ÿæˆä¼ºæœå™¨

<div align="center">

![æ”¾ Server Banner åœ–]

**åŸºæ–¼ Photon çš„åˆ†æ•£å¼ AI åœ–åƒç”Ÿæˆä¼ºæœå™¨**

[![Unity](https://img.shields.io/badge/Unity-2021.3+-black?style=flat&logo=unity)](https://unity.com/)
[![Photon](https://img.shields.io/badge/Photon-PUN2-blue)](https://www.photonengine.com/)
[![ComfyUI](https://img.shields.io/badge/ComfyUI-Compatible-green)](https://github.com/comfyanonymous/ComfyUI)


</div>

---

## ğŸ“– å°ˆæ¡ˆç°¡ä»‹

é€™æ˜¯ ComfyUI Visualizer çš„ä¼ºæœå™¨ç«¯ï¼Œè² è²¬è™•ç†å¤šäººå”ä½œè«‹æ±‚ã€æª”æ¡ˆç›£è½èˆ‡é›²ç«¯åŒæ­¥ã€‚æ¡ç”¨ Master-Client æ¶æ§‹ï¼Œæ”¯æ´å¤šäººåŒæ™‚æäº¤ç”Ÿæˆè«‹æ±‚ä¸¦è‡ªå‹•æ’éšŠè™•ç†ã€‚

### æ ¸å¿ƒç‰¹è‰²

- ğŸ¯ **æ™ºèƒ½è«‹æ±‚ä½‡åˆ—**ï¼šè‡ªå‹•ç®¡ç†å¤šäººè«‹æ±‚ï¼Œä¾åºè™•ç†
- ğŸ“ **å³æ™‚æª”æ¡ˆç›£è½**ï¼šç›£æ§ ComfyUI è¼¸å‡ºè³‡æ–™å¤¾
- â˜ï¸ **è‡ªå‹•é›²ç«¯åŒæ­¥**ï¼šç”Ÿæˆæª”æ¡ˆå³æ™‚ä¸Šå‚³ Google Drive
- ğŸ”„ **ç‹€æ…‹å³æ™‚åŒæ­¥**ï¼šæ‰€æœ‰å®¢æˆ¶ç«¯åŒæ­¥ä¼ºæœå™¨ç‹€æ…‹

---

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Photon Cloud Server                â”‚
â”‚                  (Room System)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Master Client â”‚             â”‚     Clients    â”‚
â”‚   (Host PC)    â”‚             â”‚  (User Devices)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è™•ç†è«‹æ±‚ä½‡åˆ—  â”‚             â”‚ â€¢ æäº¤åƒæ•¸      â”‚
â”‚ â€¢ åŸ·è¡Œ ComfyUI â”‚             â”‚ â€¢ æ¥æ”¶çµæœ      â”‚
â”‚ â€¢ æª”æ¡ˆç›£è½     â”‚             â”‚ â€¢ è§€å¯Ÿè¦–è¦ºåŒ–    â”‚
â”‚ â€¢ é›²ç«¯ä¸Šå‚³     â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ComfyUI API  â”‚
â”‚  (localhost)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  File Watcher  â”‚
â”‚  (4 folders)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1ï¸âƒ£ è«‹æ±‚ä½‡åˆ—ç³»çµ±

è‡ªå‹•ç®¡ç†å¤šäººè«‹æ±‚ï¼Œé˜²æ­¢è³‡æºç«¶çˆ­ï¼š
```csharp
private IEnumerator ProcessRequestQueue()
{
    isProcessingQueue = true;
    
    while (requestQueue.Count > 0)
    {
        RequestInfo currentRequest = requestQueue.Peek();
        
        // é€šçŸ¥ç•¶å‰è™•ç†çš„ç”¨æˆ¶
        Player sender = PhotonNetwork.CurrentRoom.GetPlayer(currentRequest.SenderID);
        photonView.RPC("ReceiveServerStatus", sender, "processing");
        
        // è™•ç†è«‹æ±‚...
        texttoimage.SetAllParametertxt2img(/* parameters */);
        
        yield return new WaitUntil(() => isProcessing == "finish");
        requestQueue.Dequeue();
    }
}
```

**ä½‡åˆ—ç‹€æ…‹é¡¯ç¤º**ï¼š
- ç­‰å¾…ä¸­ï¼šé¡¯ç¤ºä½‡åˆ—ä½ç½®
- è™•ç†ä¸­ï¼šå³æ™‚æ›´æ–°é€²åº¦
- å®Œæˆï¼šè‡ªå‹•é€šçŸ¥ç”¨æˆ¶

---

### 2ï¸âƒ£ å››è³‡æ–™å¤¾ç›£è½ç³»çµ±

å³æ™‚ç›£æ§ ComfyUI è¼¸å‡ºè³‡æ–™å¤¾ï¼š

| è³‡æ–™å¤¾ | ç›£è½å…§å®¹ | è™•ç†å‹•ä½œ |
|--------|---------|---------|
| ğŸ“Š ConditioningData | Token æ¬Šé‡çŸ©é™£ | ä¸Šå‚³è‡³ Google Drive |
| ğŸ¨ LatentData | æ½›ç©ºé–“ç‰¹å¾µ | ä¸Šå‚³è‡³ Google Drive |
| ğŸ–¼ï¸ VAEDebug | VAE è§£ç¢¼è³‡è¨Š | ä¸Šå‚³è‡³ Google Drive |
| ğŸŒ… PNG | æœ€çµ‚ç”Ÿæˆåœ–ç‰‡ | ä¸Šå‚³è‡³ Google Drive |

**æ™ºèƒ½æª”æ¡ˆåµæ¸¬**ï¼š
```csharp
private async Task<bool> IsFileReady(string filePath)
{
    try
    {
        using (FileStream inputStream = File.Open(filePath,
            FileMode.Open, FileAccess.Read, FileShare.Read))
        {
            return inputStream.Length > 0;
        }
    }
    catch (IOException)
    {
        return false; // æª”æ¡ˆå°šæœªå®Œæˆå¯«å…¥
    }
}
```

**é‡è©¦æ©Ÿåˆ¶**ï¼šæœ€å¤šé‡è©¦ 3 æ¬¡ï¼Œæ¯æ¬¡å»¶é²éå¢

---

### 3ï¸âƒ£ Google Drive è‡ªå‹•åŒæ­¥

æª”æ¡ˆç”Ÿæˆå¾Œè‡ªå‹•ä¸Šå‚³ä¸¦åˆ†äº«çµ¦å®¢æˆ¶ç«¯ï¼š
```csharp
private async void OnNewFileDetected(FileSystemEventArgs e, string watcherName)
{
    for (int attempt = 0; attempt < 3; attempt++)
    {
        if (await IsFileReady(e.FullPath))
        {
            switch (watcherName)
            {
                case "PNG":
                    await googleDriveManager.UploadPNGFile(e.FullPath);
                    break;
                case "LatentData":
                    await googleDriveManager.UploadLatentFile(e.FullPath);
                    break;
                // ...
            }
            return;
        }
        await Task.Delay((attempt + 1) * 1000);
    }
}
```

---

### 4ï¸âƒ£ Photon ç¶²è·¯åŒæ­¥

**RPC é€šè¨Šæ¶æ§‹**ï¼š
```csharp
// Client â†’ Master: æäº¤è«‹æ±‚
photonView.RPC("ReceivePrompt", PhotonNetwork.MasterClient, 
    width, height, seed, steps, cfg, prompt, senderId);

// Master â†’ Client: å›å‚³çµæœ
photonView.RPC("ReceiveFileIds", sender, 
    pngId, latentId, conditioningId, vaeId, "isfinish");

// Master â†’ All: å»£æ’­ç‹€æ…‹
photonView.RPC("ReceiveConfirmation", RpcTarget.Others, 
    "Current finish", isProcessing);
```

---

## ğŸ“ å°ˆæ¡ˆçµæ§‹
```
Assets/
â”œâ”€â”€ ğŸ“¡ FileAction/
â”‚   â”œâ”€â”€ PhotonPrompt.cs              # Photon ç¶²è·¯ç®¡ç†æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ è«‹æ±‚ä½‡åˆ—ç³»çµ±
â”‚   â”‚   â”œâ”€â”€ RPC é€šè¨Šè™•ç†
â”‚   â”‚   â””â”€â”€ ç‹€æ…‹åŒæ­¥ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ FileListener.cs              # æª”æ¡ˆç›£è½ç³»çµ±
â”‚   â”‚   â”œâ”€â”€ å››è³‡æ–™å¤¾ç›£è½
â”‚   â”‚   â”œâ”€â”€ æª”æ¡ˆå°±ç·’æª¢æ¸¬
â”‚   â”‚   â””â”€â”€ è‡ªå‹•ä¸Šå‚³è§¸ç™¼
â”‚   â”‚
â”‚   â”œâ”€â”€ StartVisualize.cs            # è¦–è¦ºåŒ–æµç¨‹æ§åˆ¶
â”‚   â””â”€â”€ VisualizeDataListener.cs    # è³‡æ–™æ¥æ”¶è™•ç†
â”‚
â”œâ”€â”€ â˜ï¸ GoogleDrive/
â”‚   â””â”€â”€ GoogleDriveManager.cs        # é›²ç«¯åŒæ­¥ç®¡ç†
â”‚       â”œâ”€â”€ æª”æ¡ˆä¸Šå‚³
â”‚       â”œâ”€â”€ æ¬Šé™è¨­å®š
â”‚       â””â”€â”€ ID å›å‚³
â”‚
â”œâ”€â”€ ğŸ¨ TextToImage/
â”‚   â””â”€â”€ texttoimage.cs               # ComfyUI API æ•´åˆ
â”‚       â”œâ”€â”€ JSON Workflow ç”Ÿæˆ
â”‚       â”œâ”€â”€ API è«‹æ±‚ç™¼é€
â”‚       â””â”€â”€ åƒæ•¸é©—è­‰
â”‚
â””â”€â”€ ğŸ“Š XAIData/
    â”œâ”€â”€ ConditioningData.cs          # Conditioning è³‡æ–™è™•ç†
    â””â”€â”€ LatentData.cs                # Latent è³‡æ–™è™•ç†
```

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### ç’°å¢ƒéœ€æ±‚

**ç¡¬é«”éœ€æ±‚**ï¼š
- GPU: NVIDIA RTX 3060 ä»¥ä¸Šï¼ˆVRAM â‰¥ 12GBï¼‰
- RAM: 16GB ä»¥ä¸Š
- Storage: SSD æ¨è–¦

**è»Ÿé«”éœ€æ±‚**ï¼š
- Unity 2021.3+
- ComfyUI (å·²å®‰è£è‡ªå®šç¾©ç¯€é»)
- Photon PUN 2
- Google Drive API æ†‘è­‰

### å®‰è£æ­¥é©Ÿ
```bash
# 1. Clone å°ˆæ¡ˆ
git clone https://github.com/yourusername/comfyui-server.git

# 2. è¨­å®š ComfyUI è‡ªå®šç¾©ç¯€é»
cd ComfyUI/custom_nodes
git clone https://github.com/yourusername/comfyui-debug-nodes.git

# 3. é…ç½®è³‡æ–™å¤¾è·¯å¾‘
# ç·¨è¼¯ FileListener.cs ä¸­çš„è·¯å¾‘ï¼š
# - ConditioningFolderPath
# - LatentFolderPath
# - VAEFolderPath
# - PNGFolderPath

# 4. è¨­å®š Google Drive API
# å°‡ credentials.json æ”¾å…¥å°ˆæ¡ˆæ ¹ç›®éŒ„

# 5. å•Ÿå‹• ComfyUI
python main.py --listen 127.0.0.1 --port 8188

# 6. ç”¨ Unity åŸ·è¡Œå°ˆæ¡ˆ
```

### é…ç½®æª”æ¡ˆ

**FileListener.cs** è·¯å¾‘è¨­å®šï¼š
```csharp
[SerializeField] private string ConditioningFolderPath = 
    @"C:\ComfyUI\output\ConditioningData";
[SerializeField] private string LatentFolderPath = 
    @"C:\ComfyUI\output\LatentData";
[SerializeField] private string VAEFolderPath = 
    @"C:\ComfyUI\output\VAEDebug";
[SerializeField] private string PNGFolderPath = 
    @"C:\ComfyUI\output";
```

---

## ğŸ’¡ æŠ€è¡“äº®é»

### ğŸ¯ éé˜»å¡å¼ä½‡åˆ—è™•ç†

ä½¿ç”¨ Coroutine å¯¦ç¾éåŒæ­¥ä½‡åˆ—ï¼Œé¿å… UI å‡çµï¼š
```csharp
yield return new WaitUntil(() => isProcessing == "finish");
```

### ğŸ”’ æª”æ¡ˆé–å®šæª¢æ¸¬

å¤šå±¤æª¢æ¸¬ç¢ºä¿æª”æ¡ˆå®Œæ•´æ€§ï¼š
```csharp
private bool IsFileLocked(string filePath)
{
    try
    {
        using (FileStream stream = File.Open(filePath, 
            FileMode.Open, FileAccess.ReadWrite, FileShare.None))
        {
            return false; // æª”æ¡ˆå¯ç”¨
        }
    }
    catch (IOException)
    {
        return true; // æª”æ¡ˆè¢«é–å®š
    }
}
```

### âš¡ æ™ºèƒ½é‡è©¦æ©Ÿåˆ¶

æŒ‡æ•¸é€€é¿ç­–ç•¥ï¼Œæé«˜æˆåŠŸç‡ï¼š
```csharp
for (int attempt = 0; attempt < 3; attempt++)
{
    int delayMs = (attempt + 1) * 1000; // 1s, 2s, 3s
    await Task.Delay(delayMs);
    // é‡è©¦é‚è¼¯...
}
```

### ğŸ“¡ RPC ç‹€æ…‹å»£æ’­

å³æ™‚åŒæ­¥æ‰€æœ‰å®¢æˆ¶ç«¯ç‹€æ…‹ï¼š
```csharp
public override void OnPlayerEnteredRoom(Player newPlayer)
{
    // æ–°ç©å®¶åŠ å…¥æ™‚é€šçŸ¥ç•¶å‰ç‹€æ…‹
    photonView.RPC("ReceiveConfirmation", RpcTarget.Others, 
        "Current status", isProcessing);
}
```

---

## ğŸ”„ é‹ä½œæµç¨‹

### å®Œæ•´è«‹æ±‚è™•ç†æµç¨‹

```
1. Client æäº¤è«‹æ±‚
   â†“
2. Master æ¥æ”¶ä¸¦åŠ å…¥ä½‡åˆ—
   â†“
3. å›å‚³ã€Œå·²æ¥æ”¶ã€ç¢ºèª + ä½‡åˆ—ä½ç½®
   â†“
4. ä¾åºè™•ç†ä½‡åˆ—
   â†“
5. ç™¼é€ ComfyUI API è«‹æ±‚
   â†“
6. FileListener ç›£è½è¼¸å‡ºè³‡æ–™å¤¾
   â†“
7. åµæ¸¬åˆ°æ–°æª”æ¡ˆ
   â†“
8. æª¢æŸ¥æª”æ¡ˆå®Œæ•´æ€§ï¼ˆé‡è©¦æ©Ÿåˆ¶ï¼‰
   â†“
9. ä¸Šå‚³è‡³ Google Drive
   â†“
10. å–å¾— File ID
    â†“
11. RPC å›å‚³ File IDs çµ¦ Client
    â†“
12. Client ä¸‹è¼‰ä¸¦è¦–è¦ºåŒ–
    â†“
13. è™•ç†ä¸‹ä¸€å€‹è«‹æ±‚
```

---

## ğŸ“Š æ•ˆèƒ½å„ªåŒ–

### ä½‡åˆ—è™•ç†çµ±è¨ˆ

| é …ç›® | æ•¸å€¼ |
|------|------|
| å¹³å‡ç­‰å¾…æ™‚é–“ | 30-60 ç§’/è«‹æ±‚ |
| æœ€å¤§ä¸¦ç™¼æ•¸ | 10 å€‹å®¢æˆ¶ç«¯ |
| æª”æ¡ˆä¸Šå‚³é€Ÿåº¦ | ~2 ç§’/æª”æ¡ˆ |
| è¨˜æ†¶é«”ä½”ç”¨ | ~500 MB |

### è³‡æºç®¡ç†
```csharp
void OnDestroy()
{
    // æ¸…ç† FileSystemWatcher
    foreach (var watcher in watchers)
    {
        watcher.EnableRaisingEvents = false;
        watcher.Dispose();
    }
    watchers.Clear();
}
```

---

## ğŸ› éŒ¯èª¤è™•ç†

### æª”æ¡ˆç›£è½ç•°å¸¸
```csharp
catch (Exception ex)
{
    Debug.LogWarning($"Upload attempt {attempt + 1} failed: {ex.Message}");
    if (attempt == 2) // æœ€å¾Œä¸€æ¬¡å˜—è©¦
    {
        Debug.LogError($"Failed after 3 attempts: {e.FullPath}");
    }
}
```

### ç¶²è·¯æ–·ç·šè™•ç†
```csharp
public override void OnPlayerLeftRoom(Player otherPlayer)
{
    UpdateStatus($"è¨­å‚™å·²é›¢ç·šï¼Œ{PhotonNetwork.PlayerList.Length} å€‹ä½¿ç”¨è€…");
    // è‡ªå‹•æ¸…ç†è©²ç©å®¶çš„å¾…è™•ç†è«‹æ±‚
}
```

---

## ğŸ”§ å¸¸è¦‹å•é¡Œ

<details>
<summary><b>Q: å¦‚ä½•ä¿®æ”¹ä½‡åˆ—å¤§å°é™åˆ¶ï¼Ÿ</b></summary>

ä¿®æ”¹ `PhotonPrompt.cs`ï¼š
```csharp
private const int MAX_QUEUE_SIZE = 20; // é è¨­ç„¡é™åˆ¶
```
</details>

<details>
<summary><b>Q: æª”æ¡ˆä¸Šå‚³å¤±æ•—æ€éº¼è¾¦ï¼Ÿ</b></summary>

æª¢æŸ¥ï¼š
1. Google Drive API é…é¡
2. ç¶²è·¯é€£ç·šç‹€æ…‹
3. credentials.json æ˜¯å¦æœ‰æ•ˆ
4. æª”æ¡ˆè·¯å¾‘æ¬Šé™
</details>

<details>
<summary><b>Q: å¦‚ä½•å¢åŠ é‡è©¦æ¬¡æ•¸ï¼Ÿ</b></summary>

ä¿®æ”¹ `FileListener.cs`ï¼š
```csharp
for (int attempt = 0; attempt < 5; attempt++) // æ”¹ç‚º 5 æ¬¡
```
</details>

---

## ğŸ—ºï¸ æœªä¾†è¦åŠƒ

- [ ] æ”¯æ´å¤š ComfyUI å¯¦ä¾‹è² è¼‰å¹³è¡¡
- [ ] å¯¦ä½œå„ªå…ˆæ¬Šä½‡åˆ—ç³»çµ±
- [ ] åŠ å…¥è«‹æ±‚å–æ¶ˆåŠŸèƒ½
- [ ] WebSocket æ›¿ä»£ Photonï¼ˆé™ä½å»¶é²ï¼‰
- [ ] æ”¯æ´ Redis ä½‡åˆ—æŒä¹…åŒ–
- [ ] Docker å®¹å™¨åŒ–éƒ¨ç½²

---

## ğŸ“ˆ ç›£æ§èˆ‡æ—¥èªŒ

### ä¼ºæœå™¨ç‹€æ…‹ç›£æ§
```csharp
private void UpdateStatus(string message)
{
    if (statusText != null)
        statusText.text = message;
    Debug.Log($"[{DateTime.Now:HH:mm:ss}] {message}");
}
```

### é—œéµæ—¥èªŒé»

- âœ… æ–°è«‹æ±‚æ¥æ”¶
- âœ… ä½‡åˆ—ç‹€æ…‹è®Šæ›´
- âœ… æª”æ¡ˆç›£è½è§¸ç™¼
- âœ… ä¸Šå‚³æˆåŠŸ/å¤±æ•—
- âœ… å®¢æˆ¶ç«¯é€£ç·š/æ–·ç·š

---

## ğŸ“ ç›¸é—œå°ˆæ¡ˆ

- [ComfyUI Visualizer (Client)](https://github.com/yourusername/comfyui-visualizer) - è¦–è¦ºåŒ–å®¢æˆ¶ç«¯
- [ComfyUI Debug Nodes](https://github.com/yourusername/comfyui-debug-nodes) - è‡ªå®šç¾©ç¯€é»

---

## ğŸ“§ è¯çµ¡æ–¹å¼

- ğŸ“« Email: a664104797@gmail.com

---

## ğŸ“„ æˆæ¬Š

MIT License - è©³è¦‹ [LICENSE](LICENSE)

---

<div align="center">


Made by èƒ¡ä¿®éŠ˜

</div>
